<html>
<head>
    <meta charset="utf-8">
    <title>Covid-19</title>
    <script src="/map_js/jquery.min.js"></script>
    <link rel="stylesheet" href="/css/d3tip.css">
    <link rel="stylesheet" href="css/w3.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="/map_js/d3.min.js"></script>
    <script src="/map_js/topojson.js"></script>
    <script src="/map_js/d3-tip.js"></script>
    <script src="/map_js/jquery-3.2.1.min.js" type="text/javascript"></script>
    
    <!-- slider file -->
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-queue/3.0.7/d3-queue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.0/topojson.min.js"></script>
    
    <link href="http://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css"-->

    <link rel="stylesheet" href="src/slider/bin/jquery.slider.min.css" type="text/css"/>
    <script src="src/slider/bin/jquery.slider.min.js"></script>
    <!-- bin/jquery.slider.min.css -->
    <link rel="stylesheet" href="src/slider/css/jslider.css" type="text/css">
    <link rel="stylesheet" href="src/slider/css/jslider.blue.css" type="text/css">
    <link rel="stylesheet" href="src/slider/css/jslider.plastic.css" type="text/css">
    <link rel="stylesheet" href="src/slider/css/jslider.round.css" type="text/css">
    <link rel="stylesheet" href="src/slider/css/jslider.round.plastic.css" type="text/css">
    <script type="text/javascript" src="src/slider/js/jshashtable-2.1_src.js"></script>
    <script type="text/javascript" src="src/slider/js/jquery.numberformatter-1.2.3.js"></script>
    <script type="text/javascript" src="src/slider/js/tmpl.js"></script>
    <script type="text/javascript" src="src/slider/js/jquery.dependClass-0.1.js"></script>
    <script type="text/javascript" src="src/slider/js/draggable-0.1.js"></script>
    <script type="text/javascript" src="src/slider/js/jquery.slider.js"></script>


    <!--script src="./src/lib/jquery.js"></script-->
    <script src="./src/lib/underscore-min.js"></script>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <!-- <link href="./css/font-awesome.css" rel="stylesheet"> -->
    <!-- Optional theme -->
    <link rel="stylesheet" href="./css/bootstrap-theme.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="./src/lib/bootstrap.min.js"></script>
    <script src="./src/lib/d3.v3.min.js"></script>
    <script src="./src/util.js"></script>
    <script src="./src/phylotree.js"></script>
    <link href="./css/phylotree.css" rel="stylesheet">


    <style type="text/css" media="screen">
        body
        .layout {
            padding: 50px;
            font-family: Georgia, serif;
        }

        .layout-slider {
            margin-bottom: 60px;
            width: 600px;
            padding-left: 300px
        }

        .layout-slider-settings {
            font-size: 12px;
            padding-bottom: 10px;
        }

        .layout-slider-settings pre {
            font-family: Courier;
        }
        .time-bar{
            position: absolute;
            top:0px;
            left:0px;
            width:800px;
        }

    </style>
    <style>
        .fa-rotate-45 {
            -webkit-transform: rotate(45deg);
            -moz-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            -o-transform: rotate(45deg);
            transform: rotate(45deg);
        }
        
        .fa-rotate-135 {
            -webkit-transform: rotate(135deg);
            -moz-transform: rotate(135deg);
            -ms-transform: rotate(135deg);
            -o-transform: rotate(135deg);
            transform: rotate(135deg);
        }
        
        @media (max-width: 1075px) {
            .container {
                padding-top: 50px;
            }
        }
        
        #guide {
            position: absolute;
            top: 650px;
            right: 100px;
            border-style: solid;
            border-color: black;
            border-width: 1px;
            background: white;
            opacity: 0.7;
        }
        
        #guide path.branch {
            stroke: rgb(245, 225, 225);
        }
        
        #guide path.branch:hover {
            stroke-width: 2px;
        }
        #tree_container {
            position: absolute;
            top: 700px;
            left: 100px;
        }
        #toolbar {
            position: absolute;
            top: 650px;
        }
    </style>
</head>

<body>
    <div id = 'container_map'>
        <h1>Covid-19 world map</h1>
        <svg width=1100 height=500 id="mainsvg" class="svgs"></svg>
        <svg id ='LineGraph' width=100% height=100% style='position:absolute; top:500px; left:50px' class="svgs"></svg>
        <div class="time-bar" id="time_bar">
            <!--
            <div style="width:80%; margin:auto; ">
                <div id="timeBarSlider"></div>
            </div>
            <br/>-->
            <div style="width:100%; margin:auto; padding-left: 300px;">
                <label><input type="text" id="date" value="" disabled/></label>
                <input id="Button1" type="button" value="Play"/>
                <input id="Button2" type="button" value="Pause"/>
                <div></div>
                <label id="lable"> </label>
            </div>
            <div class="layout-slider">
                <input id="Slider2" type="slider" name="start" value="1"/>
            </div>
            <script src="map_js/data.js"></script>
            <script src="map_js/main.js"></script>
            <script type="text/javascript" charset="utf-8">
                {
                    let display = $("#date");
                    display.attr("value", "1");
    
                    var slider = $("#Slider2");
                    slider.slider({
                        from: 0, to: 380, step: 1, dimension: '&nbsp;', onstatechange: function (v) {
                            display.trigger("input");
                            display.attr("value", v);
                        }, callback: function (v) {
                            let record = '';
                            for(i in selected_country){
                                if(selected_country[i] != 0){
                                    record = i;
                                }
                            }
                            remap(Number(v),record);
                        }
                    });
                    jQuery("#Button1").on("click", function(){
                        console.log("button1clicked");
                        let int = setInterval(function(){
                            jQuery("#Button2").on("click", function () {
                                jQuery("#Button2").off("click");
                                clearInterval(int);
                            });
                            const currentDay = display.val();
                            if (currentDay < 380) {
                                slider.slider("value", Number(currentDay) + 1);
                                let record1 = '';
                                for(i in selected_country){
                                    if(selected_country[i] != 0){
                                        record1 = i;
                                    }
                                }
                                //console.log(record1)
                                remap(Number(currentDay),record1);
                            }else{
                                jQuery("#Button2").off("click");
                                clearInterval(int);
                            }
                        }, 50);
                    })
                }
            </script>
        </div>
    </div>
    <div id='tooltip'></div>
    
    

    <!--时间范围选择-->
    <!--使用bootstrap的页面布局，第三行是进度条部分 Edit by MorroWind-->
    


    <div class="modal" id='newick_modal'>
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Newick string to render</h4>
                </div>
                <div class="modal-body" id='newick_body'>
                    <textarea id='nwk_spec' autofocus=t rue placeholder="" style='width: 100%; height: 100%' rows=2 0 selectionStart=1 selectionEnd=1 000>(a : 0.1, (b : 0.11, (c : 0.12, d : 0.13) : 0.14) : 0.15)</textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id='validate_newick'>Display this tree</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <div class="modal" id='newick_export_modal' >
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body" id='newick_export_body'>
                    <textarea id='nwk_export_spec' autofocus=t rue placeholder="" style='width: 100%; height: 100%' rows=2 0></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <div class='container' id="main_display">

        <div class='row'>
            <div class='col-md-12' id = 'toolbar'>
                <div class="btn-toolbar" role="toolbar">
                    <div class="btn-group">
                        <button type="button" class="btn btn-default btn-sm" data-direction='vertical' data-amount='1' title="Expand vertical spacing">
                    <i class="fa fa-arrows-v" ></i>
                </button>
                        <button type="button" class="btn btn-default btn-sm" data-direction='vertical' data-amount='-1' title="Compress vertical spacing">
                    <i class="fa  fa-compress fa-rotate-135" ></i>
                </button>
                        <button type="button" class="btn btn-default btn-sm" data-direction='horizontal' data-amount='1' title="Expand horizonal spacing">
                    <i class="fa fa-arrows-h" ></i>
                </button>
                        <button type="button" class="btn btn-default btn-sm" data-direction='horizontal' data-amount='-1' title="Compress horizonal spacing">
                    <i class="fa  fa-compress fa-rotate-45" ></i>
                </button>
                        <button type="button" class="btn btn-default btn-sm" id="sort_ascending" title="Sort deepest clades to the bototm">
                    <i class="fa fa-sort-amount-asc" ></i>
                </button>
                        <button type="button" class="btn btn-default btn-sm" id="sort_descending" title="Sort deepsest clades to the top">
                    <i class="fa fa-sort-amount-desc" ></i>
                </button>
                        <button type="button" class="btn btn-default btn-sm" id="sort_original" title="Restore original order">
                    <i class="fa fa-sort" ></i>
                </button>
                    </div>
                    <div class="btn-group" data-toggle="buttons">
                        <label class="btn btn-default active btn-sm">
                <input type="radio" name="options" class = "phylotree-layout-mode" data-mode = "linear" autocomplete="off" checked title = "Layout left-to-right"> Linear
              </label>
                        <label class="btn btn-default  btn-sm">
                <input type="radio" name="options" class = "phylotree-layout-mode" data-mode = "radial" autocomplete="off" title = "Layout radially"> Radial
              </label>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-default btn-sm active" id="toggle_animation" title="Toggle animation">
                    Animation
                </button>
                        </label>
                    </div>

                    <div class="btn-group" data-toggle="buttons">
                        <label class="btn btn-default active btn-sm">
                <input type="radio" class = "phylotree-align-toggler" data-align = "left" name="options-align" autocomplete="off" checked title = "Align tips labels to branches">
                    <i class="fa fa-align-left" ></i>
                </input>

              </label>
                        <label class="btn btn-default btn-sm">
               <input type="radio" class = "phylotree-align-toggler" data-align = "right" name="options-align" autocomplete="off" title = "Align tips labels to the edge of the plot">
                    <i class="fa fa-align-right" ></i>
                </input>
              </label>
                    </div>

                    <label class="pull-right">Selected <span class="badge" id = "selected_branch_counter">0</span> and filtered <span class="badge" id = "selected_filtered_counter">0</span> branches</label>

                </div>
            </div>
        </div>

        <div class='row'>
            <div class='col-md-12'>
                <div id="guide">
                    <svg id="tree_guide"></svg>
                </div>
                <div id='tree_container' class='tree-widget'>
                    <svg id="tree_display"></svg>
                </div>
            </div>
        </div>
    </div>

    <!--
###############################################################################################################################
-->

    <script>
        // $('#newick_export_modal').on('show.bs.modal', function(e) {
        //         $('textarea[id$="nwk_export_spec"]').val(
        //             tree.get_newick(
        //                 function(node) {
        //                     var tags = [];
        //                     selection_set.forEach(function(d) {
        //                         if (node[d]) {
        //                             tags.push(d)
        //                         };
        //                     });
        //                     if (tags.length) {
        //                         return "{" + tags.join(",") + "}";
        //                     }
        //                     return "";
        //                 }
        //             )
        //         );
        //     })
            // 选择文件作为输入
        // $("#newick_file").on("change", function(e) {
        //     var files = e.target.files; // FileList object

        //     if (files.length == 1) {
        //         var f = files[0];
        //         var reader = new FileReader();

        //         reader.onload = function(e) {
        //             var res = d3v3.layout.newick_parser(e.target.result);

        //             if (res["json"]) {
        //                 if (!("children" in res["json"])) {
        //                     res["error"] = "Empty tree";
        //                 }
        //             }

        //             var warning_div = d3v3.select("#main_display").insert("div", ":first-child");
        //             if (res["error"]) {
        //                 warning_div.attr("class", "alert alert-danger alert-dismissable")
        //                     .html("<strong>Newick parser error for file " + f.name + ": </strong> In file " + res["error"]);

        //             } else {
        //                 default_tree_settings();
        //                 tree(res);
        //                 selection_set = tree.get_parsed_tags().length > 0 ? tree.get_parsed_tags() : ["Foreground"];
        //                 selection_set.forEach((d, i) => update_selection_names(i))
        //                 current_selection_name = selection_set[0];
        //                 update_selection_names(0);
        //                 tree.svg(index_svg).layout();
        //                 warning_div.attr("class", "alert alert-success alert-dismissable")
        //                     .html("Loaded a tree from  file <strong>" + f.name + ": </strong>");
        //             }
        //             warning_div.append("button")
        //                 .attr("type", "button")
        //                 .attr("class", "close")
        //                 .attr("data-dismiss", "alert")
        //                 .attr("aria-hidden", "true")
        //                 .html("&times;");
        //         };

        //         reader.readAsText(f);
        //     }
        // });




        // $("#display_tree").on("click", function(e) {
        //     tree.options({
        //         'branches': 'straight'
        //     }, true);
        // });

        $("#mp_label").on("click", function(e) {
            tree.max_parsimony(true);
        });

        $("[data-direction]").on("click", function(e) {
            var which_function = $(this).data("direction") == 'vertical' ? tree.spacing_x : tree.spacing_y;
            which_function(which_function() + (+$(this).data("amount"))).update();
        });




        $(".phylotree-layout-mode").on("change", function(e) {
            if ($(this).is(':checked')) {
                if (tree.radial() != ($(this).data("mode") == "radial")) {
                    tree.radial(!tree.radial()).placenodes().update();
                }
            }
        });


        $("#toggle_animation").on("click", function(e) {
            var current_mode = $(this).hasClass('active');
            $(this).toggleClass('active');
            tree.options({
                'transitions': !current_mode
            });
        });


        $(".phylotree-align-toggler").on("change", function(e) {
            if ($(this).is(':checked')) {
                if (tree.align_tips($(this).data("align") == "right")) {
                    tree.placenodes().update();
                }
            }
        });





        function sort_nodes(asc) {
            tree.traverse_and_compute(function(n) {
                var d = 1;
                if (n.children && n.children.length) {
                    d += d3v3.max(n.children, function(d) {
                        return d["count_depth"];
                    });
                }
                n["count_depth"] = d;
            });
            tree.resort_children(function(a, b) {
                return (a["count_depth"] - b["count_depth"]) * (asc ? 1 : -1);
            });
        }

        $("#sort_original").on("click", function(e) {
            tree.resort_children(function(a, b) {
                return a["original_child_order"] - b["original_child_order"];
            });
        });

        $("#sort_ascending").on("click", function(e) {
            sort_nodes(true);
        });

        $("#sort_descending").on("click", function(e) {
            sort_nodes(false);
        });

        $("#and_label").on("click", function(e) {
            tree.internal_label(function(d) {
                return d.reduce(function(prev, curr) {
                    return curr[current_selection_name] && prev;
                }, true)
            }, true);
        });

        $("#or_label").on("click", function(e) {
            tree.internal_label(function(d) {
                return d.reduce(function(prev, curr) {
                    return curr[current_selection_name] || prev;
                }, false)
            }, true);
        });


        $("#filter_add").on("click", function(e) {
            tree.modify_selection(function(d) {
                    return d.tag || d[current_selection_name];
                }, current_selection_name, false, true)
                .modify_selection(function(d) {
                    return false;
                }, "tag", false, false);
        });

        $("#filter_remove").on("click", function(e) {
            tree.modify_selection(function(d) {
                return !d.tag;
            });
        });

        $("#select_all").on("click", function(e) {
            tree.modify_selection(function(d) {
                return true;
            });
        });

        $("#select_all_internal").on("click", function(e) {
            tree.modify_selection(function(d) {
                return !d3v3.layout.phylotree.is_leafnode(d.target);
            });
        });

        $("#select_all_leaves").on("click", function(e) {
            tree.modify_selection(function(d) {
                return d3v3.layout.phylotree.is_leafnode(d.target);
            });
        });


        $("#select_none").on("click", function(e) {
            tree.modify_selection(function(d) {
                return false;
            });
        });

        $("#clear_internal").on("click", function(e) {
            tree.modify_selection(function(d) {
                return d3v3.layout.phylotree.is_leafnode(d.target) ? d.target[current_selection_name] : false;
            });
        });

        $("#clear_leaves").on("click", function(e) {
            tree.modify_selection(function(d) {
                return !d3v3.layout.phylotree.is_leafnode(d.target) ? d.target[current_selection_name] : false;
            });
        });


        $("#display_dengrogram").on("click", function(e) {
            tree.options({
                'branches': 'step'
            }, true);
        });

        //    phylotree.modify_selection = function (callback, attr, place, skip_refresh, mode) {


        $("#branch_filter").on("input propertychange", function(e) {
            var filter_value = $(this).val();

            var rx = new RegExp(filter_value, "i");

            tree.modify_selection(function(n) {
                return filter_value.length && (tree.branch_name()(n.target).search(rx)) != -1;
            }, "tag");

        });

        $("#validate_newick").on("click", function(e) {
            var res = d3v3.layout.newick_parser($('textarea[id$="nwk_spec"]').val(), true);
            if (res["error"] || !res["json"]) {
                var warning_div = d3v3.select("#newick_body").selectAll("div  .alert-danger").data([res["error"]])
                warning_div.enter().append("div");
                warning_div.html(function(d) {
                    return d;
                }).attr("class", "alert-danger");

            } else {
                default_tree_settings();
                tree(res).svg(index_svg).layout();
                $('#newick_modal').modal('hide');
            }
        });

        function default_tree_settings() {
            tree = d3v3.layout.phylotree();
            tree.branch_length(null);
            tree.branch_name(null);
            tree.node_span('equal');
            tree.options({
                'draw-size-bubbles': false
            }, false);
            //tree.radial (true);
            tree.style_nodes(node_colorizer);
            tree.style_edges(edge_colorizer);
            tree.selection_label(current_selection_name);
            tree.node_circle_size(undefined);
            tree.radial(false);
        }

        function node_colorizer(element, data) {
            try {
                var count_class = 0;

                selection_set.forEach(function(d, i) {
                    if (data[d]) {
                        count_class++;
                        element.style("fill", color_scheme(i), i == current_selection_id ? "important" : null);
                    }
                });

                if (count_class > 1) {

                } else {
                    if (count_class == 0) {
                        element.style("fill", null);
                    }
                }
            } catch (e) {

            }

        }

        function edge_colorizer(element, data) {
            //console.log (data[current_selection_name]);
            try {
                var count_class = 0;

                selection_set.forEach(function(d, i) {
                    if (data[d]) {
                        count_class++;
                        element.style("stroke", color_scheme(i), i == current_selection_id ? "important" : null);
                    }
                });

                if (count_class > 1) {
                    element.classed("branch-multiple", true);
                } else
                if (count_class == 0) {
                    element.style("stroke", null)
                        .classed("branch-multiple", false);
                }
            } catch (e) {}

        }

        var valid_id = new RegExp("^[\\w]+$");

        $("#selection_name_box").on("input propertychange", function(e) {
            var name = $(this).val();

            var accept_name = (selection_set.indexOf(name) < 0) &&
                valid_id.exec(name);

            d3v3.select("#save_selection_button").classed("disabled", accept_name ? null : true);
        });

        $("#selection_rename > a").on("click", function(e) {

            d3v3.select("#save_selection_button")
                .classed("disabled", true)
                .on("click", function(e) { // save selection handler
                    var old_selection_name = current_selection_name;
                    selection_set[current_selection_id] = current_selection_name = $("#selection_name_box").val();

                    if (old_selection_name != current_selection_name) {
                        tree.update_key_name(old_selection_name, current_selection_name);
                        update_selection_names(current_selection_id);
                    }
                    send_click_event_to_menu_objects(new CustomEvent(selection_menu_element_action, {
                        'detail': ['save', this]
                    }));
                });

            d3v3.select("#cancel_selection_button")
                .classed("disabled", false)
                .on("click", function(e) { // save selection handler
                    $("#selection_name_box").val(current_selection_name);
                    send_click_event_to_menu_objects(new CustomEvent(selection_menu_element_action, {
                        'detail': ['cancel', this]
                    }));
                });

            send_click_event_to_menu_objects(new CustomEvent(selection_menu_element_action, {
                'detail': ['rename', this]
            }));
            e.preventDefault();
        });

        $("#selection_delete > a").on("click", function(e) {

            tree.update_key_name(selection_set[current_selection_id], null)
            selection_set.splice(current_selection_id, 1);

            if (current_selection_id > 0) {
                current_selection_id--;
            }
            current_selection_name = selection_set[current_selection_id];
            update_selection_names(current_selection_id)
            $("#selection_name_box").val(current_selection_name)


            send_click_event_to_menu_objects(new CustomEvent(selection_menu_element_action, {
                'detail': ['save', this]
            }));
            e.preventDefault();

        });

        $("#selection_new > a").on("click", function(e) {

            d3v3.select("#save_selection_button")
                .classed("disabled", true)
                .on("click", function(e) { // save selection handler
                    current_selection_name = $("#selection_name_box").val();
                    current_selection_id = selection_set.length;
                    selection_set.push(current_selection_name);
                    update_selection_names(current_selection_id);
                    send_click_event_to_menu_objects(new CustomEvent(selection_menu_element_action, {
                        'detail': ['save', this]
                    }));
                });

            d3v3.select("#cancel_selection_button")
                .classed("disabled", false)
                .on("click", function(e) { // save selection handler
                    $("#selection_name_box").val(current_selection_name);
                    send_click_event_to_menu_objects(new CustomEvent(selection_menu_element_action, {
                        'detail': ['cancel', this]
                    }));
                });

            send_click_event_to_menu_objects(new CustomEvent(selection_menu_element_action, {
                'detail': ['new', this]
            }));
            e.preventDefault();

        });

        function send_click_event_to_menu_objects(e) {
            $("#selection_new, #selection_delete, #selection_rename, #save_selection_name, #selection_name_box, #selection_name_dropdown").get().forEach(
                function(d) {
                    d.dispatchEvent(e);
                }
            );
        }

        function update_selection_names(id, skip_rebuild) {

            skip_rebuild = skip_rebuild || false;
            id = id || 0;


            current_selection_name = selection_set[id];
            current_selection_id = id;

            if (!skip_rebuild) {
                d3v3.selectAll(".selection_set").remove();

                d3v3.select("#selection_name_dropdown")
                    .selectAll(".selection_set")
                    .data(selection_set)
                    .enter()
                    .append("li")
                    .attr("class", "selection_set")
                    .append("a")
                    .attr("href", "#")
                    .text(function(d) {
                        return d;
                    })
                    .style("color", function(d, i) {
                        return color_scheme(i);
                    })
                    .on("click", function(d, i) {
                        update_selection_names(i, true);
                    });

            }


            d3v3.select("#selection_name_box")
                .style("color", color_scheme(id))
                .property("value", current_selection_name);

            tree.selection_label(selection_set[id]);
        }

        var index_width = 800, //$(container_id).width(),
            index_height = 600, //$(container_id).height()
            selection_set = ['Foreground'],
            current_selection_name = $("#selection_name_box").val(),
            current_selection_id = 0,
            max_selections = 10;
        color_scheme = d3v3.scale.category10(),
            selection_menu_element_action = "phylotree_menu_element_action";

        var tree = d3v3.layout.phylotree("body")
            .size([index_height, index_width])
            .separation(function(a, b) {
                return 0;
            })
            .count_handler(function(count) {
                $("#selected_branch_counter").text(function(d) {
                    return count[current_selection_name];
                });
                $("#selected_filtered_counter").text(count.tag);
            });
        //.node_span (function (a) {if (a.children && a.children.length) return 1; return isNaN (parseFloat (a["attribute"]) * 100) ? 1 : parseFloat (a["attribute"]) * 100; });

        var guide_tree, parsed;
        var data_path = "./data/nextstrain_ncov_global_timetree.nwk";
        //window.setInterval (function () {});

        var index_svg = d3v3.select("#tree_display")
            .attr("width", index_width)
            .attr("height", index_height);



        function selection_handler_name_box(e) {
            var name_box = d3v3.select(this);
            switch (e.detail[0]) {
                case 'save':
                case 'cancel':
                    name_box.property("disabled", true)
                        .style("color", color_scheme(current_selection_id));

                    break;
                case 'new':
                    name_box.property("disabled", false)
                        .property("value", "new_selection_name")
                        .style("color", color_scheme(selection_set.length));
                    break;
                case 'rename':
                    name_box.property("disabled", false);
                    break;
            }

        }

        function selection_handler_new(e) {
            var element = d3v3.select(this);
            $(this).data('tooltip', false);
            switch (e.detail[0]) {
                case 'save':
                case 'cancel':
                    if (selection_set.length == max_selections) {
                        element.classed("disabled", true);
                        $(this).tooltip({
                            'title': 'Up to ' + max_selections + ' are allowed',
                            'placement': 'left'
                        });
                    } else {
                        element.classed("disabled", null);
                    }
                    break;
                default:
                    element.classed("disabled", true);
                    break;

            }
        }

        function selection_handler_rename(e) {
            var element = d3v3.select(this);
            element.classed("disabled", (e.detail[0] == "save" || e.detail[0] == "cancel") ? null : true);
        }

        function selection_handler_save_selection_name(e) {
            var element = d3v3.select(this);
            element.style("display", (e.detail[0] == "save" || e.detail[0] == "cancel") ? "none" : null);
        }

        function selection_handler_name_dropdown(e) {
            var element = d3v3.select(this).selectAll(".selection_set");
            element.classed("disabled", (e.detail[0] == "save" || e.detail[0] == "cancel") ? null : true);
        }

        function selection_handler_delete(e) {
            var element = d3v3.select(this);
            $(this).tooltip('destroy');
            switch (e.detail[0]) {
                case 'save':
                case 'cancel':
                    if (selection_set.length == 1) {
                        element.classed("disabled", true);
                        $(this).tooltip({
                            'title': 'At least one named selection set <br> is required;<br>it can be empty, however',
                            'placement': 'bottom',
                            'html': true
                        });
                    } else {
                        element.classed("disabled", null);
                    }
                    break;
                default:
                    element.classed("disabled", true);
                    break;

            }
        }

        function get_part(parsed_json, ori_parsed, remain_depth) {
            var new_json = parsed_json;
            new_json.name = ori_parsed.name;
            if (parsed_json.children) {
                if (remain_depth === 0) {
                    delete new_json.children;
                } else {
                    var new_children = [];
                    for (var i = 0; i < parsed_json.children.length; ++i) {
                        var new_child = get_part(parsed_json.children[i], ori_parsed.children[i], remain_depth - 1);
                        new_children.push(new_child);
                    }
                    new_json.children = new_children;
                }
                return new_json;
            } else {
                return new_json;
            }
        }

        // 只有树部分
        $(document).ready(function() {
            default_tree_settings();
            d3v3.text(data_path, function(error, newick) {
                parsed = d3v3.layout.newick_parser(newick);
                not_circular_parsed = JSON.parse(JSON.stringify(parsed));
                ori_parsed = JSON.parse(JSON.stringify(parsed));
                var guide_height = 400,
                    guide_width = 400;

                d3v3.select('#guide')
                    .style('height', guide_height + 'px')
                    .style('width', guide_width + 'px');

                guide_tree = d3v3.layout.phylotree()
                    .svg(d3v3.select("#tree_guide"))
                    .options({
                        'left-right-spacing': 'fit-to-size',
                        // fit to given size top-to-bottom
                        'top-bottom-spacing': 'fit-to-size',
                        // fit to given size left-to-right
                        'collapsible': false,
                        // turn off the menu on internal nodes
                        'transitions': false,
                        // turn off d3 animations
                        'show-scale': false,
                        // disable brush
                        'brush': false,
                        // disable selections on this tree
                        'selectable': false
                    })
                    .size([guide_height - 2, guide_width])
                    .node_circle_size(0);
                guide_tree(ori_parsed).layout();
                var i = 0;
                guide_tree.traverse_and_compute(function(n) {
                    var d = 1;
                    if (!n.name) {
                        n.name = "Node" + i++;
                    }
                    if (n.children && n.children.length) {
                        d += d3v3.max(n.children, function(d) {
                            return d["count_depth"];
                        });
                    }
                    n["count_depth"] = d;
                });
                guide_tree.resort_children(function(a, b) {
                    return (a["count_depth"] - b["count_depth"]);
                });

                var x = d3v3.scale.linear()
                    .domain([0, document.body.scrollWidth])
                    .range([0, guide_width]);
                var y = d3v3.scale.linear()
                    .domain([0, document.body.scrollHeight])
                    .range([0, guide_height]);
                var rect = d3v3.select("#tree_guide")
                    .append('rect')
                    .attr('x', 0)
                    .attr('y', 0)
                    .style('opacity', .6)
                    .attr('width', x(window.innerWidth))
                    .attr('height', y(window.innerHeight));

                document.body.onscroll = function(event) {
                    rect.attr('x', x(window.scrollX))
                        .attr('y', y(window.scrollY));
                };

                d3v3.select('#guide').on("click", function() {
                    var coords = d3v3.mouse(this),
                        new_x = x.invert(coords[0]) - window.innerWidth / 2,
                        new_y = y.invert(coords[1]) - window.innerHeight / 2;
                    window.scrollTo(new_x, new_y);
                });

                
                var new_json = get_part(parsed.json, ori_parsed.json, init_show_depth);
                var new_parsed = {
                    json: new_json,
                    error: null
                };
               
                cur_tree = JSON.parse(JSON.stringify(new_json));
                tree(new_parsed).svg(index_svg).layout();

                tree.selection_callback(function(selected) {
                    guide_tree.sync_edge_labels();
                });
            })

            $("#selection_new").get(0).addEventListener(selection_menu_element_action, selection_handler_new, false);
            $("#selection_rename").get(0).addEventListener(selection_menu_element_action, selection_handler_rename, false);
            $("#selection_delete").get(0).addEventListener(selection_menu_element_action, selection_handler_delete, false);
            $("#selection_delete").get(0).dispatchEvent(new CustomEvent(selection_menu_element_action, {
                'detail': ['cancel', null]
            }));
            $("#selection_name_box").get(0).addEventListener(selection_menu_element_action, selection_handler_name_box, false);
            $("#save_selection_name").get(0).addEventListener(selection_menu_element_action, selection_handler_save_selection_name, false);
            $("#selection_name_dropdown").get(0).addEventListener(selection_menu_element_action, selection_handler_name_dropdown, false);
            update_selection_names();
        });
    </script>


</body>
</html>